<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chipta - Online Chipta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-bus"></i> Online Chipta
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="profile.html">
                    <i class="fas fa-user"></i> Profil
                </a>
                <a class="nav-link" href="index.html">
                    <i class="fas fa-home"></i> Bosh sahifa
                </a>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow fade-in">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0"><i class="fas fa-ticket-alt"></i> Chiptangiz tayyor!</h4>
                    </div>
                    <div class="card-body">
                        <div id="ticketContainer">
                            <div class="text-center mb-4">
                                <div class="loading" id="loadingSpinner"></div>
                                <p>Chipta yuklanmoqda...</p>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <button class="btn btn-primary me-2" id="printTicket">
                                <i class="fas fa-print"></i> Chiptani chop etish
                            </button>
                            <button class="btn btn-outline-primary me-2" id="saveTicket">
                                <i class="fas fa-download"></i> Yuklab olish
                            </button>
                            <a href="profile.html" class="btn btn-success">
                                <i class="fas fa-user-circle"></i> Profilga o'tish
                            </a>
                        </div>
                        
                        <div class="alert alert-info mt-4">
                            <h5><i class="fas fa-info-circle"></i> Muhim eslatmalar:</h5>
                            <ul class="mb-0">
                                <li>Chiptani yo'lda namoyish eting</li>
                                <li>Avtobusga 30 daqiqa oldin kelishingizni tavsiya qilamiz</li>
                                <li>Pasport yoki ID karta olib kelishingiz shart</li>
                                <li>Chipta ID sizning broningizni tekshirish uchun kerak bo'ladi</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-3 mt-5">
        <div class="container text-center">
            <p>&copy; 2024 Online Chipta. Barcha huquqlar himoyalangan.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let bookingData = null;
        let busData = null;
        let ticketId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Pending booking ma'lumotlarini olish
            const pendingBooking = JSON.parse(localStorage.getItem('pendingBooking'));
            
            if (!pendingBooking) {
                alert('Chipta ma\'lumotlari topilmadi!');
                window.location.href = 'search.html';
                return;
            }
            
            // Avtobus ma'lumotlarini olish
            const buses = Storage.getBuses();
            busData = buses.find(bus => bus.id == pendingBooking.busId);
            
            if (!busData) {
                alert('Avtobus ma\'lumotlari topilmadi!');
                window.location.href = 'search.html';
                return;
            }
            
            bookingData = pendingBooking;
            
            // Chiptani yaratish va saqlash
            createAndSaveTicket();
        });
        
        function createAndSaveTicket() {
            // Joriy foydalanuvchi
            const currentUser = Auth.getCurrentUser();
            if (!currentUser) {
                alert('Foydalanuvchi ma\'lumotlari topilmadi!');
                window.location.href = 'login.html';
                return;
            }
            
            // Booking ID yaratish
            ticketId = 'TKT-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            
            // Booking obyektini yaratish
            const booking = {
                id: Date.now(),
                ticketId: ticketId,
                userId: currentUser.id,
                busId: bookingData.busId,
                seats: bookingData.seats,
                totalPrice: bookingData.totalPrice,
                bookingDate: new Date().toISOString(),
                status: 'confirmed',
                paymentMethod: 'online',
                paymentStatus: 'paid'
            };
            
            // Database'ga saqlash
            const savedBooking = Storage.saveBooking(booking);
            
            // O'rindiqlarni band qilish
            Storage.bookSeats(bookingData.busId, bookingData.seats);
            
            // Pending booking'ni tozalash
            localStorage.removeItem('pendingBooking');
            
            // Chiptani ko'rsatish
            displayTicket(savedBooking, currentUser);
        }
        
        function displayTicket(booking, user) {
            const ticketContainer = document.getElementById('ticketContainer');
            
            ticketContainer.innerHTML = `
                <div class="ticket p-4 mb-4">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-start mb-4">
                                <div>
                                    <h3 class="text-primary mb-1">ONLINE CHIPTA</h3>
                                    <p class="text-muted mb-0">Avtobus chiptalari tizimi</p>
                                </div>
                                <div class="text-end">
                                    <h5 class="text-success mb-1">TASDIQLANGAN</h5>
                                    <small class="text-muted">Holati: Faol</small>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-6">
                                    <h2 class="display-6 fw-bold">${busData.from}</h2>
                                    <p class="text-muted">
                                        <i class="fas fa-calendar"></i> ${busData.date}<br>
                                        <i class="fas fa-clock"></i> ${busData.departureTime}
                                    </p>
                                </div>
                                <div class="col-6 text-end">
                                    <h2 class="display-6 fw-bold">${busData.to}</h2>
                                    <p class="text-muted">
                                        <i class="fas fa-calendar"></i> ${busData.date}<br>
                                        <i class="fas fa-clock"></i> ${busData.arrivalTime}
                                    </p>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <h6><i class="fas fa-user"></i> Yo'lovchi ma'lumotlari</h6>
                                    <p class="mb-1"><strong>Ism:</strong> ${user.name}</p>
                                    <p class="mb-1"><strong>Email:</strong> ${user.email}</p>
                                    <p class="mb-1"><strong>Telefon:</strong> ${user.phone}</p>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <h6><i class="fas fa-bus"></i> Avtobus ma'lumotlari</h6>
                                    <p class="mb-1"><strong>Avtobus raqami:</strong> ${busData.busNumber}</p>
                                    <p class="mb-1"><strong>Avtobus turi:</strong> ${busData.busType}</p>
                                    <p class="mb-1"><strong>Kompaniya:</strong> ${busData.company || 'Online Chipta'}</p>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-chair"></i> O'rindiqlar</h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        ${booking.seats.map(seat => 
                                            `<span class="badge bg-primary p-2">${seat}</span>`
                                        ).join('')}
                                    </div>
                                    <p class="mt-2 small">Jami: ${booking.seats.length} ta o'rindiq</p>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6><i class="fas fa-money-bill-wave"></i> To'lov ma'lumotlari</h6>
                                    <p class="mb-1"><strong>To'lov usuli:</strong> Onlayn</p>
                                    <p class="mb-1"><strong>To'lov holati:</strong> To'langan</p>
                                    <p class="mb-1"><strong>Bron sanasi:</strong> ${new Date(booking.bookingDate).toLocaleString('uz-UZ')}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 border-start">
                            <div class="text-center">
                                <div class="mb-4">
                                    <h4 class="text-success">Chipta ID</h4>
                                    <h2 class="fw-bold">${booking.ticketId}</h2>
                                    <small class="text-muted">Tezkor tekshirish uchun</small>
                                </div>
                                
                                <div class="mb-4">
                                    <div id="qrcode" class="mb-2">
                                        <!-- QR code joyi -->
                                        <div style="width: 200px; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                                            <div class="text-center">
                                                <i class="fas fa-qrcode fa-3x text-secondary"></i>
                                                <p class="small mt-2">QR Code simulyatsiya</p>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="text-muted">Skanner orqali tekshirish</small>
                                </div>
                                
                                <div class="border-top pt-3">
                                    <h3 class="text-primary">${booking.totalPrice.toLocaleString()} so'm</h3>
                                    <p class="text-muted">Umumiy to'lov summasi</p>
                                </div>
                                
                                <div class="mt-3">
                                    <p class="small text-muted">
                                        <i class="fas fa-exclamation-circle"></i>
                                        Ushbu chipta faqat bir marta foydalanish uchun
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-top mt-4 pt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-phone"></i> Aloqa</h6>
                                <p class="small mb-1">+998 90 123 45 67</p>
                                <p class="small mb-0">support@onlinechipta.uz</p>
                            </div>
                            <div class="col-md-6 text-end">
                                <h6><i class="fas fa-map-marker-alt"></i> Manzil</h6>
                                <p class="small mb-0">Toshkent shahri, Yunusobod tumani</p>
                                <p class="small mb-0">Online Chipta ofisi</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // QR code generatsiyasi (simulyatsiya)
            generateQRCodeSimulation();
        }
        
        function generateQRCodeSimulation() {
            // Haqiqiy QR code generator o'rniga simulyatsiya
            const qrDiv = document.querySelector('#qrcode');
            if (qrDiv) {
                // Bu joyga haqiqiy QR code generator qo'shishingiz mumkin
                // Masalan: https://davidshimjs.github.io/qrcodejs/
            }
        }
        
        // Chiptani chop etish
        document.getElementById('printTicket').addEventListener('click', function() {
            window.print();
        });
        
        // Chiptani yuklab olish
        document.getElementById('saveTicket').addEventListener('click', function() {
            const ticketElement = document.querySelector('.ticket');
            const ticketData = `
                Chipta ID: ${ticketId}
                Yo'lovchi: ${Auth.getCurrentUser().name}
                Marshrut: ${busData.from} â†’ ${busData.to}
                Sana: ${busData.date}
                Vaqt: ${busData.departureTime} - ${busData.arrivalTime}
                O'rindiqlar: ${bookingData.seats.join(', ')}
                Narx: ${bookingData.totalPrice.toLocaleString()} so'm
                Bron sanasi: ${new Date().toLocaleString('uz-UZ')}
                
                Online Chipta - avtobus chiptalari tizimi
                Telefon: +998 90 123 45 67
                Email: support@onlinechipta.uz
            `;
            
            const blob = new Blob([ticketData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chipta-${ticketId}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Chipta muvaffaqiyatli yuklab olindi!');
        });
    </script>
</body>
</html>